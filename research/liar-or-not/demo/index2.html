<html>
<head>
	<title>LiarOrNot: Demo</title>
	<link rel="stylesheet" href="style.css">
	<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script>

// idtfv by default
modality = 3;

function readTextFileNoSplit(fname)
	{
		var rawFile = new XMLHttpRequest();
    		rawFile.open("GET", fname, false);
		var allText;
   		rawFile.onreadystatechange = function ()
    		{
        		if(rawFile.readyState === 4)
        		{
            			if(rawFile.status === 200 || rawFile.status == 0)
            			{
                			allText = rawFile.responseText;				
				}
            		}
       		}
		rawFile.send(null);
		return allText;
	}

//for maintaining size of the page
function createDummyPlots(){
		document.getElementById("ges_prediction").style.visibility = false;
		document.getElementById("feat_prediction").style.visibility = false;
		var ges_data = [
						  {
						    x: ['Frown','Eyebrows Raising', 'Lip Corners Up', 'Lips Protruded', 'Head Side Turn'],
						    y: [0.5, 0.5, 0.5, 0.5, 0.5],
						    type: 'bar'
						  }
						];

			var ges_layout = {
					  title: 'Gesture Scores',
					  xaxis: {
					    tickangle: -45
					  }
					};

			Plotly.newPlot('ges_prediction', ges_data, ges_layout, {staticPlot: true});

			var trace1 = {
			  x: tr_x,
			  y: tr_y,
			  mode: 'markers',
			  type: 'scatter',
			  name: 'Truthful Video',
			  marker: { size: 12, color: "green" }
			};

			var data = [ trace1 ];

			var layout = {
			  	title:'Score Space',
			  	xaxis: {title: 'iDT+FV Scores', dtick: 0.1, zeroline: false},
  				yaxis: {title: 'Gesture Scores', dtick: 0.1, zeroline:false},
			};

			Plotly.newPlot('feat_prediction', data, layout, {staticPlot: true});

	}

function preparePage()
	{
		populateDropDownBox();
		//createDummyPlots();
		//clearPage();
	}

function populateDropDownBox()
	{
		allVideos = readTextFileNoSplit("./video_list.lst")
		allText = readTextFileNoSplit("./sample_list.lst")
		dropdownbox = document.getElementById("query");

		//map_s = readTextFileNoSplit('predDemo_selected.json');
        //	var scatter_map = JSON.parse(map_s);

		var Tlines = allText.split('\n');
		var Vlines = allVideos.split('\n');
		for(var i = 0; i < Tlines.length-1; i++)
		{
		//print(Tlines[i])
		   var opt = document.createElement("option");
		   opt.value= Vlines[i];
		   opt.innerHTML = Tlines[i]; // whatever property it has

			/*
		   pred = scatter_map[toks[0]][0];
		   gt = scatter_map[toks[0]][1];
		   if(pred==gt){
		   	opt.className = "greenText";
		   }
		   else{
		   	opt.className = "redText";
		   }
		   */

		   // then append it to the select element
		   dropdownbox.appendChild(opt);
		}
	}

	function buttonOnClickHandler(){
		//clearPage();
		
		var vids = document.getElementsByTagName('video');
		//var imgs = document.getElementsByTagName('img');
		
		v_id = document.getElementById("query").value;

		if(v_id == 0)
			return;

		// load video
		v_url = "../amt_videos/videos/".concat(v_id);
		vids[0].src = v_url;
		vids[0].load();
		vids[0].style.display = "inline";
		vids[0].setAttribute("controls", "controls");
		//vids[0].disabled = false;

		loadingData(v_id);
        }

    function loadingData(v_id){
        	
			displayTextData(v_id);
    		//displayGestureScores();
    		displayScatterPlot(v_id);

			document.getElementById("demo_plots").style.visibility = "visible";
			document.getElementById("amt_answers").style.visibility = "visible";
        }
	function changeVisibility(){
		if(document.getElementById("amt_table").style.visibility == "visible"){
			document.getElementById("amt_table").style.visibility = "hidden";
			document.getElementById("shower_link").innerHTML = "[show]";
		}
		else{
			document.getElementById("amt_table").style.visibility = "visible";
			document.getElementById("shower_link").innerHTML = "[hide]";
		}
		
	}

function displayGestureScores(){
		map_s = readTextFileNoSplit('idtfv_scatter_map.json');
        	var scatter_map = JSON.parse(map_s);
        	
        	v_id = document.getElementById("query").value;
        	v_name = v_id.split(".")[0];

        	// plot gesture scores
         	ges_scores = scatter_map[v_name][4];
        	var ges_data = [
						  {
						    x: ['Frown','Eyebrows Raising', 'Lip Corners Up', 'Lips Protruded', 'Head Side Turn'],
						    y: [ges_scores[0], ges_scores[1], ges_scores[2], ges_scores[3], ges_scores[4]],
						    type: 'bar'
						  }
						];

			var ges_layout = {
					  title: 'Predictions of different micro-expressions',
					  xaxis: {
					    tickangle: -45
					  },
					  yaxis: {
					  	dtick: 0.1
					  }
					};

			Plotly.newPlot('ges_prediction', ges_data, ges_layout, {staticPlot: true});
}

function displayTextData(v_id){
	p_id = v_id.substring(0,v_id.length-4);
	var amt_s = readTextFileNoSplit('amt_study_results.json');
	var amtdata = JSON.parse(amt_s);

	var prob_s = readTextFileNoSplit('amt_prob_preds.json');
	var probdata = JSON.parse(prob_s);

    document.getElementById("amt1Text").innerHTML = amtdata[p_id][0];
	document.getElementById("amt1Text").style.textTransform="uppercase";
	document.getElementById("amt1Text").style.color="green";
	if((amtdata[p_id][0] == "spy" && probdata[p_id][0]==1) || (amtdata[p_id][0] == "villager" && probdata[p_id][0]==2)){
		document.getElementById("amt1Text").style.color="red";
	}
	document.getElementById("amt2Text").innerHTML = amtdata[p_id][1];
	document.getElementById("amt2Text").style.textTransform="uppercase";
	document.getElementById("amt2Text").style.color="green";
	if((amtdata[p_id][1] == "spy" && probdata[p_id][0]==1) || (amtdata[p_id][1] == "villager" && probdata[p_id][0]==2)){
		document.getElementById("amt2Text").style.color="red";
	}
	document.getElementById("amt3Text").innerHTML = amtdata[p_id][2];
	document.getElementById("amt3Text").style.textTransform="uppercase";
	document.getElementById("amt3Text").style.color="green";
	if((amtdata[p_id][2] == "spy" && probdata[p_id][0]==1) || (amtdata[p_id][2] == "villager" && probdata[p_id][0]==2)){
		document.getElementById("amt3Text").style.color="red";
	}

	if(probdata[p_id][0]==2){
		gtText = "spy";
	}
	else{
		gtText = "villager";
	}
	document.getElementById("gtText").innerHTML = gtText;
	document.getElementById("gtText").style.textTransform="uppercase";
	document.getElementById("gtText").style.fontWeight="bold";
}

function displayScatterPlot(v_id){
	p_id = v_id.substring(0,v_id.length-4);
	var prob_s = readTextFileNoSplit('amt_prob_preds.json');
	var probdata = JSON.parse(prob_s);

	// gather all the points for the same game
	g_id = p_id.substring(0,p_id.length-3);
	sp_x = [[],[],[],[],[]]; sp_y = [[],[],[],[],[]];
	vil_x = [[],[],[],[],[]]; vil_y = [[],[],[],[],[]];
	for(key in probdata){
		kg_id = key.substring(0,key.length-3);
		if(kg_id == g_id){
			if(key != p_id){
				if(probdata[key][0]==1){
					// villager
					vil_x[0].push(probdata[key][1]); vil_y[0].push(0);
					vil_x[1].push(probdata[key][2]); vil_y[1].push(0);
					vil_x[2].push(probdata[key][3]); vil_y[2].push(0);
					vil_x[3].push(probdata[key][4]); vil_y[3].push(0);
					vil_x[4].push(probdata[key][5]); vil_y[4].push(0);
				}
				else{
					sp_x[0].push(probdata[key][1]); sp_y[0].push(0);
					sp_x[1].push(probdata[key][2]); sp_y[1].push(0);
					sp_x[2].push(probdata[key][3]); sp_y[2].push(0);
					sp_x[3].push(probdata[key][4]); sp_y[3].push(0);
					sp_x[4].push(probdata[key][5]); sp_y[4].push(0);
				}
			}
		}
	}

	for(i=0; i<5; i++){
		var trace_sp = {
			x: sp_x[i],
			y: sp_y[i],
			mode: 'markers',
			type: 'scatter',
			name: 'Spies',
			marker: { size: 12, color: "red" }
		};
		var trace_vil = {
			x: vil_x[i],
			y: vil_y[i],
			mode: 'markers',
			type: 'scatter',
			name: 'Villagers',
			marker: { size: 12, color: "green" }
		};
		var trace_this = {
			x: [probdata[p_id][i+1]],
			y: [0],
			mode: 'markers',
			type: 'scatter',
			name: 'Current Video',
			marker: { size: 20, color: 'blue', symbol: "star-dot" }
		};

		var data = [ trace_sp, trace_vil, trace_this ];

		var layout = {
			title:'Scores for other videos in the same game',
			xaxis: {title: 'Probability of being spy', autorange: true, dtick: 0.1, zeroline: true},
			yaxis: {ticks:'', showticklabels:false, zeroline:false, showline: false},
		};
		Plotly.newPlot('plot'+(i+1).toString(), data, layout, {staticPlot: true});
	}
}

function changeModality(radiobtn){
	modality = radiobtn.value;
	loadingData();
}
</script>

</head>
<body onLoad="preparePage();">
<div class="page-canvas">
	<div class="page-header">
		<div class="logo" style="float: left; ">
			<div style="margin-top:10px"><img src="imgs/dartmouth_logo.jpg" height=150px></div>
		  </div>
		  <div class="logo" style="float: right;">
		  	<div style="margin-top:10px"><img src="imgs/umd_logo.gif"  height=150px></div>
		  </div>
	</div>

	<div class="title">
		<br>
		<center>
			<h1> LiarOrNot: Automatic Long-Term Deception Detection<br>in Group Interaction Videos </h1>
		</center>
	</div>	
	<div class="demo-video">
		<center>
	 		<select id="query" style="width: 250px;">
	  			<option value="0">Select video</option>
			</select>
			<button type="button" onClick="buttonOnClickHandler();">Load</button>
		</center>
		<div style="margin: 0 auto; width:59%; margin-top: 25px; float:left; margin-bottom: 25px;">
			<video id="myVideo" id="q1" width=100%> <source src="../amt_videos/videos/004NTU_p1.mp4" type="video/mp4"></video>
		</div>
		<div id="amt_answers" style="margin: 0 auto; width:39%; margin-top: 25px; font-size: large; visibility: hidden; float:right">
			<center>
				Amazon Mechanichal Turk annotations: <a id="shower_link" href="#" onClick="changeVisibility();">[show]</a><br>
				<table id="amt_table" border="0" style="visibility: hidden;">
					<tr><td>Worker 1: </td><td><span id="amt1Text"></span></td></tr>
					<tr><td>Worker 2: </td><td><span id="amt2Text"></span></td></tr>
					<tr><td>Worker 3: </td><td><span id="amt3Text"></span></td></tr>
					<tr><td><br></td><td></td></tr>
					<tr><td><br></td><td></td></tr>
					<tr><td>Ground truth: </td><td><span id="gtText"></span></td></tr>
				</table>
				 <br>
			</center>
            </div>
	</div>
	<div class="demo-plots" id="demo_plots" style="visibility: visible;">
		<div id="chartContainer" style="height: 370px; width: 100%;">lalala</div>
	</div>

	<div class="footer"></div>
</div>
</body>
</html>
